<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>‚õ∑Ô∏è –¢—Ä–∞—Ç—ã –≤ –ì–æ—Ä–∞—Ö</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }
        body {
            background: #e2eaf6;
            margin: 0;
            padding: 16px;
            padding-bottom: 30px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        h1 {
            font-size: 2.3rem;
            text-align: center;
            margin: 5px 0 10px;
            color: #0f2c40;
            text-shadow: 3px 3px 0 #9fc5f0;
        }
        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 36px;
            padding: 20px;
            margin-bottom: 18px;
            box-shadow: 0 12px 30px rgba(0, 30, 60, 0.2);
            border: 2px solid white;
        }
        h2 {
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 16px;
            color: #1f4a7a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        select, input, button {
            font-size: 18px;
            padding: 16px 20px;
            border-radius: 40px;
            border: 2px solid #cbd6e6;
            width: 100%;
            margin-bottom: 14px;
            background: white;
        }
        select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="3"><polyline points="6 9 12 15 18 9"/></svg>');
            background-repeat: no-repeat;
            background-position: right 16px center;
            font-weight: 600;
        }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 18px;
        }
        .cat-btn {
            background: #f0f5fd;
            border: none;
            padding: 14px 0;
            border-radius: 50px;
            font-size: 1.8rem;
            border: 3px solid transparent;
        }
        .cat-btn.selected {
            background: #1e88e5;
            color: white;
            border-color: #0d3b66;
        }
        .big-button {
            background: #10b981;
            color: white;
            font-weight: 900;
            font-size: 24px;
            padding: 20px;
            border-radius: 60px;
            border: none;
            box-shadow: 0 7px 0 #0b7e5a;
            transition: 0.05s;
        }
        .big-button:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #0b7e5a;
        }
        .add-participant {
            display: flex;
            gap: 10px;
        }
        .add-participant input {
            flex: 1;
            margin-bottom: 0;
            padding: 16px;
        }
        .add-participant button {
            width: auto;
            background: #f97316;
            color: white;
            font-weight: bold;
            padding: 16px 22px;
            border-radius: 50px;
            border: none;
            box-shadow: 0 5px 0 #b45f0a;
            white-space: nowrap;
            margin-bottom: 0;
        }
        .expense-full-list {
            max-height: 270px;
            overflow-y: auto;
        }
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #bdd3ec;
        }
        .expense-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .expense-cat {
            font-size: 1.7rem;
        }
        .expense-payer {
            background: #c1daf5;
            padding: 4px 12px;
            border-radius: 40px;
            font-weight: 700;
        }
        .expense-date {
            font-size: 13px;
            color: #336699;
            background: #eef4fa;
            padding: 3px 8px;
            border-radius: 30px;
        }
        .expense-amount {
            font-weight: 800;
            font-size: 18px;
            margin-right: 8px;
        }
        .delete-btn {
            background: none;
            border: none;
            font-size: 26px;
            color: #aa2222;
            font-weight: bold;
            cursor: pointer;
        }
        .debt-item {
            background: #e8f2fe;
            border-radius: 28px;
            padding: 18px;
            margin-bottom: 12px;
            border-left: 10px solid #0f7b6b;
        }
        .debt-payer { font-weight: 900; color: #b13e3e; font-size: 1.2rem; }
        .debt-receiver { font-weight: 900; color: #127c6c; font-size: 1.2rem; }
        .debt-amount { font-size: 28px; font-weight: 900; margin-top: 6px; }
        .total-sum {
            font-size: 22px;
            text-align: center;
            background: #0d3347;
            color: white;
            padding: 18px;
            border-radius: 60px;
            margin-top: 20px;
        }
        .empty-state {
            text-align: center;
            color: #6f8faf;
            padding: 30px 0;
            font-style: italic;
        }

        /* –ú–û–î–ê–õ–ö–ê –ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: 0.2s;
        }
        .modal-overlay.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background: #fef9e8;
            width: 90%;
            max-width: 450px;
            border-radius: 70px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 30px 60px black;
            border: 5px solid #f7c35c;
            transform: scale(0.9);
            transition: 0.2s;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-joke {
            font-size: 32px;
            font-weight: 900;
            line-height: 1.4;
            margin: 20px 0;
            color: #1f2937;
        }
        .modal-emoji {
            font-size: 70px;
        }
        .modal-button {
            background: #f97316;
            border: none;
            color: white;
            font-size: 28px;
            font-weight: bold;
            padding: 22px 20px;
            border-radius: 120px;
            width: 100%;
            box-shadow: 0 8px 0 #b0450c;
            transition: 0.05s;
        }
        .modal-button:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #b0450c;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üèîÔ∏è –ì–û–†–´ 2026</h1>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–ø—É—Å—Ç–æ–π —Å—Ç–∞—Ä—Ç) -->
    <div class="card">
        <h2>‚õ∑Ô∏è –î–æ–±–∞–≤—å –≥–æ–Ω—â–∏–∫–æ–≤</h2>
        <select id="payer"></select>
        <div class="add-participant">
            <input type="text" id="newParticipant" placeholder="–ò–º—è, –Ω–∞–ø—Ä. –ö–æ–ª—è–Ω">
            <button id="addParticipantBtn">‚ûï</button>
        </div>
    </div>

    <!-- –í–≤–æ–¥ —Ç—Ä–∞—Ç—ã -->
    <div class="card">
        <h2>üí∏ –ó–∞–ø–∏—Å–∞—Ç—å</h2>
        <div class="category-grid">
            <button class="cat-btn" data-cat="üçî">üçî</button>
            <button class="cat-btn" data-cat="üç∫">üç∫</button>
            <button class="cat-btn" data-cat="üè®">üè®</button>
            <button class="cat-btn" data-cat="üèãÔ∏è">üèãÔ∏è</button>
            <button class="cat-btn" data-cat="‚õΩ">‚õΩ</button>
            <button class="cat-btn" data-cat="üö°">üö°</button>
        </div>
        <input type="text" id="description" readonly value="üçî">
        <input type="number" id="amount" placeholder="–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö" step="1" min="0">
        <button class="big-button" id="addExpense">–ó–ê–ü–ò–°–ê–¢–¨</button>
    </div>

    <!-- –í—Å–µ —Ç—Ä–∞—Ç—ã (—Å –¥–∞—Ç–æ–π) -->
    <div class="card">
        <h2>üìã –í—Å–µ —Ç—Ä–∞—Ç—ã</h2>
        <div id="fullExpenseList" class="expense-full-list"></div>
    </div>

    <!-- –î–æ–ª–≥–∏ -->
    <div class="card">
        <h2>üßæ –ö—Ç–æ –∫–æ–º—É –¥–æ–ª–∂–µ–Ω</h2>
        <div id="debtsList"></div>
        <div id="totalSpent" class="total-sum">0 ‚ÇΩ</div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù -->
<div id="jokeModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-emoji">üèÇ‚ùÑÔ∏è</div>
        <div class="modal-joke" id="modalJokeText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button class="modal-button" id="modalGotItBtn">–ü–†–û–ß–ò–¢–ê–ù–û üî•</button>
    </div>
</div>

<script>
    // --- –•—Ä–∞–Ω–∏–ª–∏—â–µ ---
    let expenses = [];
    let participants = []; // –¢–ï–ü–ï–†–¨ –ü–û–õ–ù–û–°–¢–¨–Æ –ü–£–°–¢–û

    // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
    const payerSelect = document.getElementById('payer');
    const newParticipantInput = document.getElementById('newParticipant');
    const addParticipantBtn = document.getElementById('addParticipantBtn');
    const catButtons = document.querySelectorAll('.cat-btn');
    const descInput = document.getElementById('description');
    const amountInput = document.getElementById('amount');
    const addBtn = document.getElementById('addExpense');
    const fullListDiv = document.getElementById('fullExpenseList');
    const debtsDiv = document.getElementById('debtsList');
    const totalSpan = document.getElementById('totalSpent');
    const modalOverlay = document.getElementById('jokeModal');
    const modalJokeText = document.getElementById('modalJokeText');
    const modalGotItBtn = document.getElementById('modalGotItBtn');

    // --- –ü—Ä–∏–∫–æ–ª—ã (–ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω) ---
    const jokes = [
        "–õ–û–•! –û–ü–Ø–¢–¨ –¢–†–ê–¢–ò–®–¨?",
        "–°–ö–ò–ü–ê–°–° –°–ê–ú –ù–ï –ö–£–ü–ò–¢–°–Ø!",
        "–î–ï–ù–¨–ì–ò –£–õ–ï–¢–ï–õ–ò –ë–´–°–¢–†–ï–ï –¢–ï–ë–Ø –° –ì–û–†–´!",
        "–¢–´ –ß–ï, –¢–ê–ú –®–ê–ú–ü–ê–ù–°–ö–û–ï –†–ê–ó–õ–ò–í–ê–Æ–¢?",
        "–ö–û–®–ï–õ–Å–ö –ü–õ–ê–ß–ï–¢ –ì–û–†–Æ–ß–ò–ú–ò –°–õ–ï–ó–ê–ú–ò",
        "–≠–ô, –®–£–ú–ê–•–ï–†, –ü–†–ò–¢–û–†–ú–û–ó–ò!",
        "–≠–¢–û –ë–´–õ–ò –ü–û–°–õ–ï–î–ù–ò–ï –ù–ê –ë–£–¢–ï–†–ë–†–û–î–´?",
        "–°–ï–ì–û–î–ù–Ø –¢–´ –ì–ï–†–û–ô, –ó–ê–í–¢–†–ê ‚Äî –ë–û–ú–ñ –ù–ê –°–ö–õ–û–ù–ï",
        "–ö–†–ï–î–ò–¢–ö–ê –î–´–ú–ò–¢, –ö–ê–ö –¢–í–û–ò –¢–û–†–ú–û–ó–ê!",
        "–ë–ê–ë–ö–ò –†–ê–°–¢–ê–Ø–õ–ò –ë–´–°–¢–†–ï–ï –°–ù–ï–ì–ê –í–ï–°–ù–û–ô",
        "–¢–†–ê–¢–ò–¢–¨ ‚Äî –¢–í–û–Å –ì–û–†–ù–û–õ–´–ñ–ù–û–ï –ê–ú–ü–õ–£–ê",
        "–ú–ï–ì–ê–†–ê–°–•–û–î! –¢–ê–ö –ò –î–û –î–û–õ–ì–û–í–û–ô –Ø–ú–´",
        "–¢–´ –°–õ–£–ß–ê–ô–ù–û –ù–ï –û–õ–ò–ì–ê–†–•?",
        "–û–ü, –ò –°–ù–û–í–ê –ú–ò–ù–£–° –ù–ê –ö–ê–†–¢–ï",
        "–î–ï–ù–¨–ì–ò –õ–Æ–ë–Ø–¢ –°–ß–Å–¢, –ê –¢–´ –ò–• –¢–†–ê–¢–ò–®–¨",
        "–ü–û–î–£–ú–ê–ô –û –ó–ê–í–¢–†–ê–®–ù–ï–ú –î–ù–ï... –•–ê-–•–ê",
        "–ë–Æ–î–ñ–ï–¢ –¢–†–ï–©–ò–¢ –ü–û –®–í–ê–ú!",
        "–ù–£ –¢–´ –ò –ú–û–¢! –í–°–Å –ù–ê –ö–ê–§–ï?",
        "–°–ö–û–†–û –ü–†–û–î–ê–í–ê–¢–¨ –õ–´–ñ–ò –ü–†–ò–î–Å–¢–°–Ø",
        "–≠–ö–û–ù–û–ú–¨, –°–£–ü–ï–†–°–¢–ê–†!"
    ];

    // --- –ú–æ–¥–∞–ª–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω (—Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ –∏—Å—á–µ–∑–∞–µ—Ç) ---
    function showFullscreenJoke(payerName = '', amount = 0) {
        let randomIndex = Math.floor(Math.random() * jokes.length);
        let joke = jokes[randomIndex];
        if (payerName && Math.random() > 0.4) {
            joke = payerName + '! ' + joke;
        }
        if (amount > 7000 && Math.random() > 0.5) {
            joke = joke + '  –¶–ï–õ–´–• ' + amount + ' –†–£–ë.';
        }
        modalJokeText.innerText = joke;
        modalOverlay.classList.add('show');
    }

    // --- –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É (—Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ) ---
    modalGotItBtn.addEventListener('click', function() {
        modalOverlay.classList.remove('show');
    });

    // --- –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
    catButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            catButtons.forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            descInput.value = this.dataset.cat;
        });
    });
    catButtons[0]?.classList.add('selected');
    descInput.value = 'üçî';

    // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ select ---
    function updateParticipantsSelect() {
        let html = '';
        participants.forEach(p => {
            html += `<option value="${p}">${p}</option>`;
        });
        payerSelect.innerHTML = html;
    }

    // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ---
    addParticipantBtn.addEventListener('click', function() {
        const newName = newParticipantInput.value.trim();
        if (newName === '') {
            modalJokeText.innerText = '–ò–ú–Ø –í–í–ï–î–ò, –ô–ï–¢–ò!';
            modalOverlay.classList.add('show');
            return;
        }
        if (participants.includes(newName)) {
            modalJokeText.innerText = '–¢–ê–ö–û–ô –£–ñ–ï –ï–°–¢–¨, –ì–û–õ–û–í–ê!';
            modalOverlay.classList.add('show');
            return;
        }
        participants.push(newName);
        updateParticipantsSelect();
        newParticipantInput.value = '';
        renderFullList();
        renderDebts();
        // –ù–µ–±–æ–ª—å—à–æ–π —Ç–æ—Å—Ç –≤–º–µ—Å—Ç–æ –º–æ–¥–∞–ª–∫–∏, –Ω–æ –º–æ–∂–Ω–æ –∏ –º–æ–¥–∞–ª–∫—É
        modalJokeText.innerText = `üèÜ ${newName} –í –°–û–°–¢–ê–í–ï! –ü–û–ì–ù–ê–õ–ò!`;
        modalOverlay.classList.add('show');
    });

    // --- –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ ---
    addBtn.addEventListener('click', function() {
        if (participants.length === 0) {
            modalJokeText.innerText = '–°–ù–ê–ß–ê–õ–ê –ì–û–°–¢–ï–ô –î–û–ë–ê–í–¨!';
            modalOverlay.classList.add('show');
            return;
        }
        const payer = payerSelect.value;
        const description = descInput.value;
        const amount = parseFloat(amountInput.value);

        if (!payer) {
            modalJokeText.innerText = '–í–´–ë–ï–†–ò, –ö–¢–û –ü–õ–ê–¢–ò–¢!';
            modalOverlay.classList.add('show');
            return;
        }
        if (isNaN(amount) || amount <= 0) {
            modalJokeText.innerText = '–°–£–ú–ú–£ –ù–û–†–ú–ê–õ–¨–ù–£–Æ –í–ü–ò–®–ò!';
            modalOverlay.classList.add('show');
            return;
        }

        // –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
        const now = new Date();
        const dateStr = now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'numeric' });
        const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

        expenses.push({
            payer: payer,
            desc: description,
            amount: amount,
            date: dateStr,
            time: timeStr,
            timestamp: now.getTime()
        });

        amountInput.value = '';
        renderFullList();
        renderDebts();
        showFullscreenJoke(payer, amount);
    });

    // --- –£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ ---
    function deleteExpense(index) {
        const deleted = expenses[index];
        if (deleted) {
            expenses.splice(index, 1);
            renderFullList();
            renderDebts();
            modalJokeText.innerText = `‚ùå –¢–†–ê–¢–ê ${deleted.desc} –£–î–ê–õ–ï–ù–ê! –ú–û–õ–û–î–ï–¶!`;
            modalOverlay.classList.add('show');
        }
    }

    // --- –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞—Ç (—Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º) ---
    function renderFullList() {
        if (expenses.length === 0) {
            fullListDiv.innerHTML = '<div class="empty-state">‚õ∑Ô∏è –ü–û–ö–ê –ù–ò–ß–ï–ì–û –ù–ï –ü–û–¢–†–ê–ß–ï–ù–û</div>';
            return;
        }
        let html = '';
        [...expenses].reverse().forEach((exp, revIndex) => {
            const originalIndex = expenses.length - 1 - revIndex;
            html += `
                <div class="expense-item">
                    <div class="expense-left">
                        <span class="expense-cat">${exp.desc}</span>
                        <span class="expense-payer">${exp.payer}</span>
                        <span class="expense-date">${exp.date || '?'} ${exp.time || ''}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span class="expense-amount">${exp.amount} ‚ÇΩ</span>
                        <button class="delete-btn" data-index="${originalIndex}">‚úï</button>
                    </div>
                </div>
            `;
        });
        fullListDiv.innerHTML = html;
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = e.target.dataset.index;
                if (index !== undefined) deleteExpense(parseInt(index));
            });
        });
    }

    // --- –†–∞—Å—á–µ—Ç –¥–æ–ª–≥–æ–≤ ---
    function renderDebts() {
        if (expenses.length === 0 || participants.length === 0) {
            debtsDiv.innerHTML = '<div class="empty-state">‚õ∑Ô∏è –î–û–ë–ê–í–¨ –õ–Æ–î–ï–ô –ò –¢–†–ê–¢–´</div>';
            totalSpan.innerHTML = '0 ‚ÇΩ';
            return;
        }

        let spent = {};
        participants.forEach(p => spent[p] = 0);
        let total = 0;
        expenses.forEach(exp => {
            if (spent.hasOwnProperty(exp.payer)) {
                spent[exp.payer] += exp.amount;
                total += exp.amount;
            }
        });

        const average = total / participants.length;
        let balance = {};
        participants.forEach(p => {
            balance[p] = spent[p] - average;
        });

        let debtors = [];
        let creditors = [];
        participants.forEach(p => {
            const bal = Math.round(balance[p] * 100) / 100;
            if (bal < -0.01) debtors.push({ name: p, amount: -bal });
            else if (bal > 0.01) creditors.push({ name: p, amount: bal });
        });

        let transactions = [];
        let i = 0, j = 0;
        let sortedDebtors = debtors.map(d => ({ ...d }));
        let sortedCreditors = creditors.map(c => ({ ...c }));

        while (i < sortedDebtors.length && j < sortedCreditors.length) {
            let debtor = sortedDebtors[i];
            let creditor = sortedCreditors[j];
            let amount = Math.min(debtor.amount, creditor.amount);
            amount = Math.round(amount * 100) / 100;

            if (amount > 0.01) {
                transactions.push({ from: debtor.name, to: creditor.name, amount: amount });
            }

            debtor.amount -= amount;
            creditor.amount -= amount;

            if (debtor.amount < 0.01) i++;
            if (creditor.amount < 0.01) j++;
        }

        if (transactions.length === 0) {
            debtsDiv.innerHTML = '<div class="empty-state">üí∞ –í–°–ï –ü–†–ò –°–í–û–ò–•</div>';
        } else {
            let html = '';
            transactions.forEach(t => {
                html += `
                    <div class="debt-item">
                        <div><span class="debt-payer">${t.from}</span> ‚Üí <span class="debt-receiver">${t.to}</span></div>
                        <div class="debt-amount">üí∏ ${t.amount} ‚ÇΩ</div>
                    </div>
                `;
            });
            debtsDiv.innerHTML = html;
        }

        totalSpan.innerHTML = `üí∞ –í–°–ï–ì–û: ${total} ‚ÇΩ`;
    }

    // --- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä (–≤—Å—ë –ø—É—Å—Ç–æ) ---
    updateParticipantsSelect();
    renderFullList();
    renderDebts();
</script>
</body>
</html>
