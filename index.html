<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatkullin Simple</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background: #1e2f4a;
            color: white;
            margin: 0;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 30px;
            padding: 20px;
            margin: 20px 0;
            color: black;
        }
        input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ccc;
            border-radius: 25px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 25px;
            background: #fbbf24;
            color: #1e2f4a;
            font-weight: bold;
            margin: 5px 0;
            cursor: pointer;
        }
        button.red {
            background: #dc2626;
            color: white;
        }
        video {
            width: 100%;
            background: black;
            border-radius: 20px;
            margin: 5px 0;
        }
        .hidden {
            display: none;
        }
        .code {
            background: #1e2f4a;
            color: #fbbf24;
            padding: 15px;
            border-radius: 15px;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fatkullin Video</h1>
        
        <!-- –≠–∫—Ä–∞–Ω 1: –í—Ö–æ–¥ -->
        <div id="screen1" class="card">
            <h2>üëã –í—Ö–æ–¥</h2>
            <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è" value="User">
            <button onclick="enter()">–í–æ–π—Ç–∏</button>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω 2: –û–∂–∏–¥–∞–Ω–∏–µ -->
        <div id="screen2" class="card hidden">
            <h2>üë§ <span id="displayName"></span></h2>
            <p>–í–∞—à –∫–æ–¥:</p>
            <div class="code" id="myCode"></div>
            <hr>
            <h3>–ü–æ–∑–≤–æ–Ω–∏—Ç—å</h3>
            <input type="text" id="targetCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
            <button onclick="startCall()">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            <button class="red" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω 3: –ó–≤–æ–Ω–æ–∫ -->
        <div id="screen3" class="card hidden">
            <video id="remoteVideo" autoplay></video>
            <video id="localVideo" autoplay muted></video>
            <button class="red" onclick="hangup()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // –ü—Ä–æ—Å—Ç—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let myId = '';
        let myName = '';
        let localStream = null;
        let peerConnection = null;
        let remoteStream = null;
        
        // STUN —Å–µ—Ä–≤–µ—Ä
        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };
        
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–∏–≥–Ω–∞–ª–æ–≤
        let signals = JSON.parse(localStorage.getItem('signals') || '{}');
        
        // –í—Ö–æ–¥
        function enter() {
            myName = document.getElementById('userName').value || 'User';
            myId = 'user_' + Date.now().toString().slice(-6);
            
            document.getElementById('displayName').innerText = myName;
            document.getElementById('myCode').innerText = myId;
            
            showScreen2();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥—è—â–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            setInterval(checkSignals, 2000);
        }
        
        // –í—ã—Ö–æ–¥
        function logout() {
            showScreen1();
        }
        
        // –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
        async function startCall() {
            const targetId = document.getElementById('targetCode').value;
            if (!targetId) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
            
            try {
                // –í–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                document.getElementById('localVideo').srcObject = localStream;
                
                // –°–æ–∑–¥–∞—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                peerConnection = new RTCPeerConnection(config);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        saveSignal(targetId, {
                            type: 'candidate',
                            from: myId,
                            candidate: event.candidate
                        });
                    }
                };
                
                // –°–æ–∑–¥–∞—ë–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                saveSignal(targetId, {
                    type: 'offer',
                    from: myId,
                    fromName: myName,
                    offer: offer
                });
                
                showScreen3();
                
                alert('‚úÖ –ó–≤–æ–Ω–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\n\n–¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ—Å–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–µ');
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + e.message);
            }
        }
        
        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        function hangup() {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (peerConnection) peerConnection.close();
            showScreen2();
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∏–≥–Ω–∞–ª
        function saveSignal(to, signal) {
            if (!signals[to]) signals[to] = [];
            signals[to].push(signal);
            localStorage.setItem('signals', JSON.stringify(signals));
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–∏–≥–Ω–∞–ª—ã
        function checkSignals() {
            if (!myId) return;
            
            const mySignals = signals[myId];
            if (!mySignals || mySignals.length === 0) return;
            
            const signal = mySignals.shift();
            localStorage.setItem('signals', JSON.stringify(signals));
            
            if (signal.type === 'offer') {
                // –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
                if (confirm(`üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${signal.fromName || signal.from}\n–û—Ç–≤–µ—Ç–∏—Ç—å?`)) {
                    answerCall(signal);
                }
            }
            else if (signal.type === 'answer' && peerConnection) {
                peerConnection.setRemoteDescription(signal.answer);
            }
            else if (signal.type === 'candidate' && peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
            }
        }
        
        // –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫
        async function answerCall(signal) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                document.getElementById('localVideo').srcObject = localStream;
                
                peerConnection = new RTCPeerConnection(config);
                
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        saveSignal(signal.from, {
                            type: 'candidate',
                            from: myId,
                            candidate: event.candidate
                        });
                    }
                };
                
                await peerConnection.setRemoteDescription(signal.offer);
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                saveSignal(signal.from, {
                    type: 'answer',
                    from: myId,
                    answer: answer
                });
                
                showScreen3();
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        function showScreen1() {
            document.getElementById('screen1').classList.remove('hidden');
            document.getElementById('screen2').classList.add('hidden');
            document.getElementById('screen3').classList.add('hidden');
        }
        
        function showScreen2() {
            document.getElementById('screen1').classList.add('hidden');
            document.getElementById('screen2').classList.remove('hidden');
            document.getElementById('screen3').classList.add('hidden');
        }
        
        function showScreen3() {
            document.getElementById('screen1').classList.add('hidden');
            document.getElementById('screen2').classList.add('hidden');
            document.getElementById('screen3').classList.remove('hidden');
        }
    </script>
</body>
</html>
