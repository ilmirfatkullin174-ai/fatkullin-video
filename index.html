<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatkullin –≤–∏–¥–µ–æ</title>
    <style>
        body { 
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 15px;
            background: #1e2f4a;
            color: white;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .logo {
            font-size: 32px;
            font-weight: bold;
            color: gold;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            color: black;
            box-shadow: 0 10px 0 #0f1f33;
        }
        
        .id-box {
            background: #1e2f4a;
            color: gold;
            padding: 20px;
            border-radius: 15px;
            font-size: 22px;
            font-weight: bold;
            word-break: break-all;
            margin: 10px 0;
            border: 2px solid gold;
        }
        
        input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ccc;
            border-radius: 30px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        
        button {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 30px;
            background: gold;
            color: #1e2f4a;
            margin: 8px 0;
            cursor: pointer;
            box-shadow: 0 5px 0 #b8860b;
        }
        
        button.red {
            background: #dc2626;
            color: white;
            box-shadow: 0 5px 0 #7f1d1d;
        }
        
        button:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #b8860b;
        }
        
        .video-box {
            background: black;
            border-radius: 20px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
            min-height: 300px;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #localVideo {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 80px;
            height: 120px;
            border-radius: 10px;
            border: 2px solid white;
            object-fit: cover;
        }
        
        .hidden {
            display: none;
        }
        
        .step {
            font-size: 14px;
            color: #64748b;
            margin: 10px 0;
        }
        
        .online-users {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 15px;
            margin: 10px 0;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üì± Fatkullin Video</div>
        
        <!-- –®–ê–ì 1: –í—Ö–æ–¥ -->
        <div id="step1">
            <div class="card">
                <h2>üëã –í—Ö–æ–¥</h2>
                <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è" value="User" maxlength="20">
                <button id="enterBtn">–í–æ–π—Ç–∏</button>
            </div>
        </div>
        
        <!-- –®–ê–ì 2: –ì–ª–∞–≤–Ω–∞—è -->
        <div id="step2" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="displayName"></h3>
                    <button id="exitBtn" style="width: auto; padding: 10px 20px;">–í—ã—Ö–æ–¥</button>
                </div>
                
                <div class="id-box" id="myId"></div>
                <div class="step">‚¨ÜÔ∏è –í–∞—à ID. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∏–º!</div>
                
                <hr style="margin: 20px 0;">
                
                <h3>üìû –ö–æ–º—É –ø–æ–∑–≤–æ–Ω–∏—Ç—å?</h3>
                <input type="text" id="targetId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
                <button id="callBtn">–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            </div>
        </div>
        
        <!-- –®–ê–ì 3: –ó–≤–æ–Ω–æ–∫ -->
        <div id="step3" class="hidden">
            <div class="card">
                <h3 id="callStatus">–ó–≤–æ–Ω–æ–∫...</h3>
                
                <div class="video-box">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <video id="localVideo" autoplay playsinline muted></video>
                </div>
                
                <button class="red" id="hangupBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            </div>
        </div>
        
        <!-- –í–•–û–î–Ø–©–ò–ô –ó–í–û–ù–û–ö -->
        <div id="incomingCall" class="hidden">
            <div class="card">
                <h2 style="color: #dc2626;">üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫!</h2>
                <p id="callerName"></p>
                <div style="display: flex; gap: 10px;">
                    <button id="acceptBtn" style="flex: 2;">‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                    <button class="red" id="declineBtn" style="flex: 1;">‚ùå</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= –ü–†–û–°–¢–ï–ô–®–ï–ï –†–ï–®–ï–ù–ò–ï =============
        
        let myId = '';
        let myName = '';
        let localStream = null;
        let peerConnection = null;
        let callActive = false;
        
        // STUN —Å–µ—Ä–≤–µ—Ä—ã
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };
        
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–∏–≥–Ω–∞–ª–æ–≤
        let signals = JSON.parse(localStorage.getItem('calls') || '{}');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const incomingCall = document.getElementById('incomingCall');
        const myIdEl = document.getElementById('myId');
        const displayName = document.getElementById('displayName');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideo = document.getElementById('localVideo');
        const callStatus = document.getElementById('callStatus');
        const callerName = document.getElementById('callerName');
        
        // –í—Ö–æ–¥
        document.getElementById('enterBtn').onclick = () => {
            myName = document.getElementById('userName').value || 'User';
            myId = 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
            
            displayName.textContent = `üë§ ${myName}`;
            myIdEl.textContent = myId;
            
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ö–æ–¥—è—â–∏—Ö
            checkIncoming();
        };
        
        // –í—ã—Ö–æ–¥
        document.getElementById('exitBtn').onclick = () => {
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
            }
        };
        
        // –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
        document.getElementById('callBtn').onclick = async () => {
            const targetId = document.getElementById('targetId').value;
            if (!targetId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∫–∞–º–µ—Ä—É
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                localVideo.srcObject = localStream;
                
                // –°–æ–∑–¥–∞—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                peerConnection = new RTCPeerConnection(config);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                peerConnection.ontrack = (event) => {
                    remoteVideo.srcObject = event.streams[0];
                };
                
                // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        sendSignal(targetId, {
                            type: 'candidate',
                            from: myId,
                            candidate: event.candidate
                        });
                    }
                };
                
                // –°–æ–∑–¥–∞—ë–º –æ—Ñ—Ñ–µ—Ä
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ñ—Ñ–µ—Ä
                sendSignal(targetId, {
                    type: 'offer',
                    from: myId,
                    fromName: myName,
                    offer: offer
                });
                
                callStatus.textContent = 'üìû –ó–≤–æ–Ω–∏–º...';
                step2.classList.add('hidden');
                step3.classList.remove('hidden');
                callActive = true;
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + e);
            }
        };
        
        // –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫
        document.getElementById('acceptBtn').onclick = async () => {
            const callData = signals[myId]?.pop();
            if (!callData) return;
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∫–∞–º–µ—Ä—É
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                localVideo.srcObject = localStream;
                
                // –°–æ–∑–¥–∞—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                peerConnection = new RTCPeerConnection(config);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                peerConnection.ontrack = (event) => {
                    remoteVideo.srcObject = event.streams[0];
                };
                
                // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        sendSignal(callData.from, {
                            type: 'candidate',
                            from: myId,
                            candidate: event.candidate
                        });
                    }
                };
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ñ—Ñ–µ—Ä
                await peerConnection.setRemoteDescription(callData.offer);
                
                // –°–æ–∑–¥–∞—ë–º –æ—Ç–≤–µ—Ç
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                sendSignal(callData.from, {
                    type: 'answer',
                    from: myId,
                    answer: answer
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–≤–æ–Ω–∫–∞
                incomingCall.classList.add('hidden');
                step2.classList.add('hidden');
                step3.classList.remove('hidden');
                callStatus.textContent = 'üî¥ –†–∞–∑–≥–æ–≤–æ—Ä';
                callActive = true;
                
                localStorage.setItem('calls', JSON.stringify(signals));
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e);
            }
        };
        
        // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        document.getElementById('declineBtn').onclick = () => {
            incomingCall.classList.add('hidden');
            step2.classList.remove('hidden');
        };
        
        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        document.getElementById('hangupBtn').onclick = () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
            
            remoteVideo.srcObject = null;
            localVideo.srcObject = null;
            
            step3.classList.add('hidden');
            step2.classList.remove('hidden');
            callActive = false;
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞
        function sendSignal(to, signal) {
            if (!signals[to]) signals[to] = [];
            signals[to].push(signal);
            localStorage.setItem('calls', JSON.stringify(signals));
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö
        function checkIncoming() {
            setInterval(() => {
                if (!myId || callActive) return;
                
                const mySignals = signals[myId];
                if (mySignals && mySignals.length > 0) {
                    const signal = mySignals[mySignals.length - 1];
                    
                    if (signal.type === 'offer') {
                        // –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
                        callerName.textContent = `üìû ${signal.fromName || signal.from}`;
                        step2.classList.add('hidden');
                        incomingCall.classList.remove('hidden');
                    }
                    else if (signal.type === 'answer' && peerConnection) {
                        // –û—Ç–≤–µ—Ç –Ω–∞ –Ω–∞—à –∑–≤–æ–Ω–æ–∫
                        peerConnection.setRemoteDescription(signal.answer);
                        callStatus.textContent = 'üî¥ –†–∞–∑–≥–æ–≤–æ—Ä';
                        signals[myId] = [];
                    }
                    else if (signal.type === 'candidate' && peerConnection) {
                        // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç
                        peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
                        signals[myId] = signals[myId].filter(s => s.type !== 'candidate');
                    }
                    
                    localStorage.setItem('calls', JSON.stringify(signals));
                }
            }, 1000);
        }
    </script>
</body>
</html>
