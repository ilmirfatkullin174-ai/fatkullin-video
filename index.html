<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatkullin Video</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #0a1a2a;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .app {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 30px;
            overflow: hidden;
        }
        
        .header {
            background: #1e2f4a;
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .logo {
            font-size: 32px;
            color: gold;
            font-weight: bold;
        }
        
        .content {
            padding: 20px;
        }
        
        .card {
            background: #f5f5f5;
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
        }
        
        button {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            border: none;
            border-radius: 30px;
            background: gold;
            color: #1e2f4a;
            font-weight: bold;
            margin: 10px 0;
            cursor: pointer;
        }
        
        button.red {
            background: #dc2626;
            color: white;
        }
        
        input, textarea {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 15px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        
        textarea {
            height: 100px;
            font-size: 12px;
        }
        
        .code-box {
            background: #1e2f4a;
            color: gold;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            word-break: break-all;
            margin: 10px 0;
        }
        
        .hidden {
            display: none;
        }
        
        video {
            width: 100%;
            background: black;
            border-radius: 15px;
            margin: 5px 0;
        }
        
        #localVideo {
            width: 100px;
            height: 130px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            border: 3px solid white;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="logo">Fatkullin Video</div>
            <p>–°–µ–º–µ–π–Ω—ã–µ –∑–≤–æ–Ω–∫–∏</p>
        </div>
        
        <div class="content">
            <!-- –≠–∫—Ä–∞–Ω 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
            <div id="screen1">
                <div class="card">
                    <h3>üëã –í—Ö–æ–¥</h3>
                    <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è" value="User">
                    <button onclick="register()">–í–æ–π—Ç–∏</button>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 2: –ì–ª–∞–≤–Ω—ã–π -->
            <div id="screen2" class="hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between;">
                        <h3><span id="displayName"></span></h3>
                        <button onclick="logout()" style="width: auto; padding: 8px 15px;">–í—ã–π—Ç–∏</button>
                    </div>
                    
                    <p>–í–∞—à ID:</p>
                    <div class="code-box" id="myId"></div>
                    
                    <hr style="margin: 20px 0;">
                    
                    <h3>üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</h3>
                    <input type="text" id="targetId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
                    <button onclick="step1Call()">–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 3: –û–∂–∏–¥–∞–Ω–∏–µ -->
            <div id="screen3" class="hidden">
                <div class="card">
                    <h3>üì§ –®–ê–ì 1</h3>
                    <p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥:</p>
                    <textarea id="offerCode" readonly></textarea>
                    <button onclick="copyOffer()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <p style="color: #666; margin: 10px 0;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –≤ Telegram/WhatsApp</p>
                    <button onclick="waitForAnswer()">–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª, –∂–¥—É –æ—Ç–≤–µ—Ç</button>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 4: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ -->
            <div id="screen4" class="hidden">
                <div class="card">
                    <h3>‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞</h3>
                    <p>–ü–æ–ø—Ä–æ—Å–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –ø—Ä–∏—Å–ª–∞—Ç—å –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞</p>
                    <textarea id="answerInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Å—é–¥–∞"></textarea>
                    <button onclick="step2Answer()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 5: –í—Ö–æ–¥—è—â–∏–π -->
            <div id="screen5" class="hidden">
                <div class="card">
                    <h3 style="color: #dc2626;">üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h3>
                    <p>–í–∞–º –∑–≤–æ–Ω—è—Ç! –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</p>
                    <textarea id="incomingOffer" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥"></textarea>
                    <button onclick="acceptCall()">‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                    <button class="red" onclick="cancelCall()">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 6: –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ -->
            <div id="screen6" class="hidden">
                <div class="card">
                    <h3>üì§ –®–ê–ì 2</h3>
                    <p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:</p>
                    <textarea id="answerCode" readonly></textarea>
                    <button onclick="copyAnswer()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button onclick="startCall()">–ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä</button>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 7: –ó–≤–æ–Ω–æ–∫ -->
            <div id="screen7" class="hidden">
                <video id="remoteVideo" autoplay></video>
                <video id="localVideo" autoplay muted></video>
                <button class="red" onclick="endCall()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let myId = '';
        let myName = '';
        let localStream = null;
        let peerConnection = null;
        let currentOffer = null;
        
        // STUN —Å–µ—Ä–≤–µ—Ä
        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        function register() {
            myName = document.getElementById('userName').value || 'User';
            myId = myName + '_' + Math.random().toString(36).substring(2, 8);
            
            document.getElementById('displayName').innerText = myName;
            document.getElementById('myId').innerText = myId;
            
            showScreen('screen2');
        }
        
        // –í—ã—Ö–æ–¥
        function logout() {
            showScreen('screen1');
        }
        
        // –®–ê–ì 1: –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
        async function step1Call() {
            const targetId = document.getElementById('targetId').value;
            if (!targetId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
                return;
            }
            
            try {
                // –í–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                document.getElementById('localVideo').srcObject = localStream;
                
                // –°–æ–∑–¥–∞—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                peerConnection = new RTCPeerConnection(config);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                // –°–æ–∑–¥–∞—ë–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const offerData = {
                    type: 'offer',
                    from: myId,
                    fromName: myName,
                    to: targetId,
                    offer: offer
                };
                
                document.getElementById('offerCode').value = JSON.stringify(offerData);
                currentOffer = offerData;
                
                showScreen('screen3');
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + e.message);
            }
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        function copyOffer() {
            const text = document.getElementById('offerCode').value;
            navigator.clipboard.writeText(text);
            alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É');
        }
        
        // –ñ–¥—É –æ—Ç–≤–µ—Ç
        function waitForAnswer() {
            showScreen('screen4');
        }
        
        // –®–ê–ì 2: –í—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
        async function step2Answer() {
            const answerText = document.getElementById('answerInput').value;
            
            try {
                const answerData = JSON.parse(answerText);
                
                if (answerData.type === 'answer') {
                    await peerConnection.setRemoteDescription(answerData.answer);
                    showScreen('screen7');
                }
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞');
            }
        }
        
        // –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ (–¥–ª—è –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ)
        function acceptCall() {
            const offerText = document.getElementById('incomingOffer').value;
            
            try {
                const offerData = JSON.parse(offerText);
                handleIncoming(offerData);
            } catch (e) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞');
            }
        }
        
        async function handleIncoming(offerData) {
            try {
                // –í–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                document.getElementById('localVideo').srcObject = localStream;
                
                // –°–æ–∑–¥–∞—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                peerConnection = new RTCPeerConnection(config);
                
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                // –ü—Ä–∏–Ω–∏–º–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                await peerConnection.setRemoteDescription(offerData.offer);
                
                // –°–æ–∑–¥–∞—ë–º –æ—Ç–≤–µ—Ç
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const answerData = {
                    type: 'answer',
                    from: myId,
                    to: offerData.from,
                    answer: answer
                };
                
                document.getElementById('answerCode').value = JSON.stringify(answerData);
                
                showScreen('screen6');
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç
        function copyAnswer() {
            const text = document.getElementById('answerCode').value;
            navigator.clipboard.writeText(text);
            alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É');
        }
        
        // –ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä (–ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞)
        function startCall() {
            showScreen('screen7');
        }
        
        // –û—Ç–∫–ª–æ–Ω–∏—Ç—å
        function cancelCall() {
            showScreen('screen2');
        }
        
        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
            showScreen('screen2');
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        function showScreen(screenId) {
            const screens = ['screen1', 'screen2', 'screen3', 'screen4', 'screen5', 'screen6', 'screen7'];
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö (–¥–ª—è –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ)
        window.checkIncoming = function() {
            showScreen('screen5');
        };
    </script>
</body>
</html>
