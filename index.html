<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>üèîÔ∏è –¢—Ä–∞—Ç—ã –≤ –ì–æ—Ä–∞—Ö</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }
        body {
            background: #d4e8ff;
            margin: 0;
            padding: 16px;
            padding-bottom: 30px;
            position: relative;
            min-height: 100vh;
        }
        body::before {
            content: "‚ùÑÔ∏è‚ùÑÔ∏è‚ùÑÔ∏è";
            position: fixed;
            top: 10px;
            left: 0;
            width: 100%;
            font-size: 40px;
            color: rgba(255, 255, 255, 0.3);
            text-align: center;
            pointer-events: none;
            z-index: -1;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }
        h1 {
            font-size: 2.2rem;
            text-align: center;
            margin: 5px 0 15px;
            color: #0b2b44;
            text-shadow: 3px 3px 0 #aac9ff;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 40px;
            padding: 22px;
            margin-bottom: 20px;
            box-shadow: 0 15px 30px rgba(0, 40, 80, 0.3);
            border: 2px solid white;
        }
        h2 {
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 16px;
            color: #1f4a7a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        select, input, button {
            font-size: 18px;
            padding: 16px 20px;
            border-radius: 50px;
            border: 2px solid #c0d0e8;
            width: 100%;
            margin-bottom: 14px;
            background: white;
        }
        .big-button {
            background: #10b981;
            color: white;
            font-weight: 900;
            font-size: 24px;
            padding: 20px;
            border-radius: 60px;
            border: none;
            box-shadow: 0 7px 0 #0b7e5a;
            transition: 0.1s;
        }
        .big-button:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #0b7e5a;
        }
        .add-participant {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .add-participant input {
            flex: 1;
            margin-bottom: 0;
        }
        .add-participant button {
            width: 60px;
            padding: 16px 0;
            background: #f97316;
            color: white;
            font-weight: bold;
            border: none;
            box-shadow: 0 5px 0 #b45f0a;
        }
        .type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        .type-btn {
            background: #eef3fc;
            border: 3px solid transparent;
            padding: 12px 16px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            flex: 1 1 auto;
        }
        .type-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #1e4b8f;
        }
        .participant-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 40px;
            font-weight: 600;
            margin: 4px;
            border: 2px solid #a0c0e0;
            background: white;
        }
        
        /* –õ–ò–ü–ö–û–ï –û–ö–ù–û –ü–õ–ê–¢–ï–õ–¨–©–ò–ö–ê */
        .payer-card {
            background: linear-gradient(145deg, #2563eb, #1e40af);
            color: white;
            padding: 14px 18px;
            border-radius: 40px;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 5px 0 #1e3a8a;
            border: 2px solid #93c5fd;
            position: sticky;
            top: 10px;
            z-index: 100;
        }
        .payer-card span {
            font-size: 24px;
        }
        
        .category-section {
            margin-bottom: 20px;
        }
        .category-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .cat-btn {
            background: #eef3fc;
            border: none;
            padding: 12px 16px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            border: 3px solid transparent;
            flex: 1 0 auto;
        }
        .cat-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #1e4b8f;
        }
        .add-category {
            display: flex;
            gap: 8px;
        }
        .add-category input {
            flex: 1;
            margin-bottom: 0;
            padding: 12px;
        }
        .add-category button {
            width: 60px;
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 0;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 0 #6d28d9;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            background: #e2eaf6;
            border: none;
            padding: 14px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            border: 2px solid #b9d2f0;
        }
        .tab.active {
            background: #3b82f6;
            color: white;
            border-color: #1e4b8f;
        }
        
        .participants-checkbox {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: #f0f7ff;
            padding: 18px;
            border-radius: 40px;
            margin: 15px 0;
            border: 2px solid #b9d2f0;
        }
        .participant-check-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 10px 16px;
            border-radius: 40px;
            border: 2px solid #b9d2f0;
        }
        .participant-check-item input {
            width: 22px;
            height: 22px;
            margin: 0;
        }
        
        .receipt-item {
            background: #f0f7ff;
            border-radius: 30px;
            padding: 18px;
            margin-bottom: 15px;
            border: 2px solid #b9d2f0;
        }
        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .receipt-header h4 {
            margin: 0;
            color: #1e3a8a;
        }
        .remove-item {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 40px;
            padding: 8px 16px;
            font-weight: bold;
            box-shadow: 0 3px 0 #991b1b;
        }
        .add-item-btn {
            background: #f97316;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin: 10px 0;
            box-shadow: 0 5px 0 #c2410c;
        }
        
        .expense-full-list {
            max-height: 250px;
            overflow-y: auto;
        }
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 2px solid #c1d4ec;
        }
        .expense-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .expense-payer {
            background: #c1daf5;
            padding: 5px 14px;
            border-radius: 40px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .expense-badge {
            font-size: 1.2rem;
            background: white;
            padding: 4px 10px;
            border-radius: 30px;
            border: 2px solid #b9d2f0;
        }
        .delete-btn {
            background: none;
            border: none;
            font-size: 26px;
            color: #aa2222;
            font-weight: bold;
            cursor: pointer;
        }
        
        .debt-item {
            background: #e8f2fe;
            border-radius: 28px;
            padding: 18px;
            margin-bottom: 12px;
            border-left: 10px solid #0f7b6b;
        }
        .debt-payer { font-weight: 900; color: #b13e3e; font-size: 1.2rem; }
        .debt-receiver { font-weight: 900; color: #127c6c; font-size: 1.2rem; }
        .debt-amount { font-size: 28px; font-weight: 900; margin-top: 6px; }
        .total-sum {
            font-size: 22px;
            text-align: center;
            background: #0d3347;
            color: white;
            padding: 18px;
            border-radius: 60px;
            margin-top: 20px;
        }
        .empty-state {
            text-align: center;
            color: #6f8faf;
            padding: 20px 0;
            font-style: italic;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: 0.2s;
        }
        .modal-overlay.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background: #fff7e6;
            width: 90%;
            max-width: 450px;
            border-radius: 70px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 30px 50px black;
            border: 5px solid #f7b731;
        }
        .modal-joke {
            font-size: 32px;
            font-weight: 900;
            line-height: 1.4;
            margin: 20px 0;
            color: #1f2937;
        }
        .modal-emoji {
            font-size: 70px;
        }
        .modal-button {
            background: #f97316;
            border: none;
            color: white;
            font-size: 28px;
            font-weight: bold;
            padding: 22px;
            border-radius: 120px;
            width: 100%;
            box-shadow: 0 8px 0 #b0450c;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: #1f4a7a;
        }
    </style>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
</head>
<body>

<div class="container">
    <h1>üèîÔ∏è –ì–û–†–´ 2026</h1>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ–Ω—â–∏–∫–æ–≤ -->
    <div class="card">
        <h2>‚õ∑Ô∏è –ì–æ–Ω—â–∏–∫–∏</h2>
        <div class="add-participant">
            <input type="text" id="newParticipant" placeholder="–ò–º—è (–î–∏–º–∞, –°–∞—à–∞...)">
            <button id="addParticipantBtn">‚ûï</button>
        </div>
        <div class="type-selector">
            <button class="type-btn selected" data-type="üèÇ">üèÇ –°–Ω–æ—É–±–æ—Ä–¥</button>
            <button class="type-btn" data-type="‚õ∑Ô∏è">‚õ∑Ô∏è –õ—ã–∂–∏</button>
            <button class="type-btn" data-type="ü¶ö">ü¶ö –ü–∞–≤–ª–∏–Ω</button>
        </div>
        <div id="participantsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="card">
        <h2>üí∏ –ù–æ–≤–∞—è —Ç—Ä–∞—Ç–∞</h2>
        
        <!-- –õ–ò–ü–ö–û–ï –æ–∫–Ω–æ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ -->
        <div class="payer-card" id="currentPayerDisplay">
            <span id="selectedPayerEmoji">üë§</span>
            <span id="selectedPayerName">–í—ã–±–µ—Ä–∏ –∫—Ç–æ –ø–ª–∞—Ç–∏—Ç</span>
        </div>
        
        <select id="payer">
            <option value="">–í—ã–±–µ—Ä–∏ –∫—Ç–æ –ø–ª–∞—Ç–∏—Ç</option>
        </select>

        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="category-section">
            <div class="category-grid" id="categoryGrid"></div>
            <div class="add-category">
                <input type="text" id="newCategory" placeholder="–ù–æ–≤–∞—è (üçî –®–∞—à–ª—ã–∫)">
                <button id="addCategoryBtn">‚ûï</button>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <button class="tab active" id="tabAll">üçª –ù–∞ –≤—Å–µ—Ö</button>
            <button class="tab" id="tabSelected">üéØ –ö—Ç–æ —É—á–∞—Å—Ç–≤—É–µ—Ç</button>
            <button class="tab" id="tabReceipt">üìù –ß–µ–∫</button>
        </div>

        <div id="inputContainer"></div>
        <button class="big-button" id="addExpense">üèîÔ∏è –ó–ê–ü–ò–°–ê–¢–¨</button>
    </div>

    <!-- –í—Å–µ —Ç—Ä–∞—Ç—ã -->
    <div class="card">
        <h2>üìã –í—Å–µ —Ç—Ä–∞—Ç—ã</h2>
        <div id="fullExpenseList" class="expense-full-list"></div>
    </div>

    <!-- –î–æ–ª–≥–∏ -->
    <div class="card">
        <h2>üßæ –ö—Ç–æ –∫–æ–º—É –¥–æ–ª–∂–µ–Ω</h2>
        <div id="debtsList"></div>
        <div id="totalSpent" class="total-sum">0 ‚ÇΩ</div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div id="jokeModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-emoji" id="modalEmoji">üèÇ</div>
        <div class="modal-joke" id="modalJokeText"></div>
        <button class="modal-button" id="modalGotItBtn">–ü–†–û–ß–ò–¢–ê–ù–û üî•</button>
    </div>
</div>

<script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ê FIREBASE =====
    const firebaseConfig = {
        apiKey: "AIzaSyCLp2XyscnKwqUHIKrYuC6S40fRkFoHkoc",
        authDomain: "cach-79d1c.firebaseapp.com",
        databaseURL: "https://cach-79d1c-default-rtdb.firebaseio.com/",
        projectId: "cach-79d1c",
        storageBucket: "cach-79d1c.firebasestorage.app",
        messagingSenderId: "487135929966",
        appId: "1:487135929966:web:c6b5768640ea812bb7e87f"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ===== –î–ê–ù–ù–´–ï =====
    let expenses = [];
    let participants = [];
    let categories = ['üçî –ï–¥–∞', 'üç∫ –ü–∏–≤–æ', 'ü•õ –ú–æ–ª–æ–∫–æ', 'üè® –û—Ç–µ–ª—å', 'üèãÔ∏è –ë–∞–Ω—è', '‚õΩ –ë–µ–Ω–∑–∏–Ω', 'üö° –°–∫–∏–ø–∞—Å—Å'];
    let selectedType = 'üèÇ';
    let currentTab = 'all';
    let selectedCategory = 'üçî –ï–¥–∞';
    let pendingDeleteIndex = null;

    // –ñ–Å–°–¢–ö–ò–ï –ü–†–ò–ö–û–õ–´
    const jokes = [
        { text: "–¢–´ –ß–ï, –ë–û–ì–ê–ß? –û–ü–Ø–¢–¨ –î–ï–ù–¨–ì–ò –ü–†–û–°–ò–†–ê–ï–®–¨?", emoji: "ü§°" },
        { text: "–ü–ò–í–û ‚Äî –≠–¢–û –°–í–Ø–¢–û–ï, –ù–û –¢–´ –£–ñ–ï –ü–û–•–û–ñ –ù–ê –ë–û–ß–ö–£!", emoji: "üç∫" },
        { text: "–ú–û–õ–û–ö–û? –¢–´ –ß–ï, –ú–ê–õ–ï–ù–¨–ö–ò–ô? –ò–î–ò –ü–ò–í–û –ü–ï–ô!", emoji: "ü•õüòÇ" },
        { text: "–ü–ê–í–õ–ò–ù, –¢–´ –ß–ï –¢–ê–ö–û–ô –ö–†–ê–°–ò–í–´–ô? –î–ï–ù–¨–ì–ò –¢–û –ï–°–¢–¨?", emoji: "ü¶ö" },
        { text: "–°–ù–û–£–ë–û–†–î–ò–°–¢–´ –í–°–ï–ì–î–ê –ë–ï–ó –î–ï–ù–ï–ì, –ù–£ –¢–´ –ü–û–ù–Ø–õ", emoji: "üèÇ" },
        { text: "–õ–´–ñ–ù–ò–ö–ò –î–£–ú–ê–Æ–¢ –ß–¢–û –û–ù–ò –ö–†–£–¢–´–ï, –ê –¢–´ –ü–†–û–°–¢–û –¢–†–ê–¢–ò–®–¨", emoji: "‚õ∑Ô∏è" },
        { text: "–ë–ê–ë–ö–ò –£–õ–ï–¢–ï–õ–ò –ë–´–°–¢–†–ï–ï –¢–ï–ë–Ø –° –ì–û–†–´, –õ–û–•!", emoji: "üí∏" },
        { text: "–¢–´ –°–ö–û–†–û –ë–£–î–ï–®–¨ –ü–†–û–î–ê–¢–¨ –¢–†–£–°–´ –ù–ê –ü–û–î–™–Å–ú–ù–ò–ö–ï", emoji: "ü©≤" },
        { text: "–≠–¢–ê –¢–†–ê–¢–ê –ë–´–õ–ê –¢–ï–ë–ï –ù–£–ñ–ù–ê –ö–ê–ö –ü–†–û–®–õ–û–ì–û–î–ù–ò–ô –°–ù–ï–ì", emoji: "‚ùÑÔ∏è" },
        { text: "–¢–´ –ì–î–ï –¢–ê–ö –ú–ù–û–ì–û –î–ï–ù–ï–ì –í–ó–Ø–õ? –ò–õ–ò –≠–¢–û –ö–†–ò–î–ò–¢–ö–ê?", emoji: "üí≥" },
        { text: "–°–ö–û–†–û –ë–£–î–ï–®–¨ –ï–°–¢–¨ –û–î–ù–ò –ú–ê–ö–ê–†–û–ù–´, –ü–û–ù–¢–û–†–ï–ó", emoji: "üçù" },
        { text: "–¢–í–û–ò –î–ï–ù–¨–ì–ò –ü–õ–ê–ß–£–¢ –ö–†–û–í–ê–í–´–ú–ò –°–õ–ï–ó–ê–ú–ò", emoji: "üò≠" },
        { text: "–ô–ï–¢–ò –û–î–û–ë–†–Ø–ï–¢ –¢–í–û–Æ –¢–†–ê–¢–£, –ù–û –¢–´ –í–°–Å –†–ê–í–ù–û –õ–û–•", emoji: "üêª" },
        { text: "–ü–ê–í–õ–ò–ù, –†–ê–°–ü–£–°–¢–ò–õ –•–í–û–°–¢ –ò –î–ï–ù–¨–ì–ò –†–ê–°–ü–£–°–¢–ò–õ", emoji: "ü¶ö" },
        { text: "–£–í–ï–†–ï–ù –ß–¢–û –•–û–ß–ï–®–¨ –£–î–ê–õ–ò–¢–¨? –ê –ï–°–õ–ò –ü–û–î–£–ú–ê–¢–¨?", emoji: "ü§î" },
        { text: "–£–î–ê–õ–ò–®–¨ ‚Äî –ë–û–õ–¨–®–ï –ù–ï –í–ï–†–ù–Å–®–¨, –õ–û–•!", emoji: "üóëÔ∏è" },
        { text: "–¢–û–ß–ù–û? –ú–û–ñ–ï–¢ –õ–£–ß–®–ï –û–°–¢–ê–í–ò–ú?", emoji: "üò¨" },
        { text: "–ê –ß–ï –ù–ê –í–°–ï–• –ù–ï –î–ï–õ–ò–®–¨? –ñ–ê–î–ò–ù–ê?", emoji: "ü¶ä" },
        { text: "–û–ü–Ø–¢–¨ –¢–û–õ–¨–ö–û –î–õ–Ø –ò–ó–ë–†–ê–ù–ù–´–•? –ê –ú–´?", emoji: "üò¢" },
        { text: "–ù–£ –¢–´ –ò –°–û–ë–ò–†–ê–¢–ï–õ–¨ –ö–û–ú–ü–ê–ù–ò–ò!", emoji: "üßê" }
    ];

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const payerSelect = document.getElementById('payer');
    const newParticipantInput = document.getElementById('newParticipant');
    const addParticipantBtn = document.getElementById('addParticipantBtn');
    const typeBtns = document.querySelectorAll('.type-btn');
    const participantsListDiv = document.getElementById('participantsList');
    const categoryGrid = document.getElementById('categoryGrid');
    const newCategoryInput = document.getElementById('newCategory');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const tabAll = document.getElementById('tabAll');
    const tabSelected = document.getElementById('tabSelected');
    const tabReceipt = document.getElementById('tabReceipt');
    const inputContainer = document.getElementById('inputContainer');
    const addExpenseBtn = document.getElementById('addExpense');
    const fullListDiv = document.getElementById('fullExpenseList');
    const debtsDiv = document.getElementById('debtsList');
    const totalSpan = document.getElementById('totalSpent');
    const selectedPayerEmoji = document.getElementById('selectedPayerEmoji');
    const selectedPayerName = document.getElementById('selectedPayerName');
    
    const modalOverlay = document.getElementById('jokeModal');
    const modalJokeText = document.getElementById('modalJokeText');
    const modalEmoji = document.getElementById('modalEmoji');
    const modalGotItBtn = document.getElementById('modalGotItBtn');

    // ===== –§–£–ù–ö–¶–ò–ò FIREBASE =====
    function loadFromFirebase() {
        const dbRef = firebase.database().ref('gory2026');
        dbRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                participants = data.participants || [];
                expenses = data.expenses || [];
                categories = data.categories || categories;
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase');
            }
            updateUI();
            renderCategories();
            renderFullList();
            renderDebts();
        });
    }

    function saveToFirebase() {
        firebase.database().ref('gory2026').set({
            participants: participants,
            expenses: expenses,
            categories: categories
        }).then(() => {
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase');
        }).catch((error) => {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        });
    }

    // ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
    function showJoke(text = null, emoji = null) {
        if (text) {
            modalJokeText.innerText = text;
            modalEmoji.innerText = emoji || 'üé≤';
        } else {
            const joke = jokes[Math.floor(Math.random() * jokes.length)];
            modalJokeText.innerText = joke.text;
            modalEmoji.innerText = joke.emoji;
        }
        modalOverlay.classList.add('show');
    }

    modalGotItBtn.addEventListener('click', () => {
        modalOverlay.classList.remove('show');
        if (pendingDeleteIndex !== null) {
            expenses.splice(pendingDeleteIndex, 1);
            pendingDeleteIndex = null;
            renderFullList();
            renderDebts();
            saveToFirebase();
            showJoke('üóëÔ∏è –ù–£ –í–°–Å, –£–î–ê–õ–ò–õ! –î–û–í–û–õ–ï–ù?', 'üòè');
        }
    });

    typeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            typeBtns.forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            selectedType = this.dataset.type;
        });
    });

    function renderCategories() {
        let html = '';
        categories.forEach(cat => {
            html += `<button class="cat-btn ${cat === selectedCategory ? 'selected' : ''}" data-cat="${cat}">${cat}</button>`;
        });
        categoryGrid.innerHTML = html;
        
        document.querySelectorAll('.cat-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedCategory = this.dataset.cat;
            });
        });
    }

    addCategoryBtn.addEventListener('click', function() {
        const cat = newCategoryInput.value.trim();
        if (!cat) {
            showJoke('–ù–ê–ü–ò–®–ò –ö–ê–¢–ï–ì–û–†–ò–Æ!', 'üìù');
            return;
        }
        categories.push(cat);
        newCategoryInput.value = '';
        renderCategories();
        saveToFirebase();
        showJoke(`‚ûï –ù–û–í–ê–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø: ${cat}`, 'üè∑Ô∏è');
    });

    function updateUI() {
        let selectHtml = '<option value="">–í—ã–±–µ—Ä–∏ –∫—Ç–æ –ø–ª–∞—Ç–∏—Ç</option>';
        participants.forEach(p => {
            selectHtml += `<option value="${p.name}">${p.type} ${p.name}</option>`;
        });
        payerSelect.innerHTML = selectHtml;
        
        let listHtml = '';
        participants.forEach(p => {
            listHtml += `<span class="participant-badge">${p.type} ${p.name}</span>`;
        });
        participantsListDiv.innerHTML = listHtml;
        
        updatePayerDisplay();
        renderTabContent();
    }

    function updatePayerDisplay() {
        const selected = payerSelect.value;
        if (selected) {
            const p = participants.find(p => p.name === selected);
            if (p) {
                selectedPayerEmoji.innerText = p.type;
                selectedPayerName.innerText = p.name;
            } else {
                selectedPayerEmoji.innerText = 'üë§';
                selectedPayerName.innerText = selected;
            }
        } else {
            selectedPayerEmoji.innerText = 'üë§';
            selectedPayerName.innerText = '–í—ã–±–µ—Ä–∏ –∫—Ç–æ –ø–ª–∞—Ç–∏—Ç';
        }
    }

    payerSelect.addEventListener('change', updatePayerDisplay);

    addParticipantBtn.addEventListener('click', function() {
        const name = newParticipantInput.value.trim();
        if (!name) {
            showJoke('–ò–ú–Ø –í–í–ï–î–ò!', 'üò§');
            return;
        }
        if (participants.some(p => p.name === name)) {
            showJoke('–¢–ê–ö–û–ô –£–ñ–ï –ï–°–¢–¨!', 'ü§¶');
            return;
        }
        participants.push({ name, type: selectedType });
        newParticipantInput.value = '';
        updateUI();
        saveToFirebase();
        showJoke(`üèîÔ∏è ${selectedType} ${name} –í –°–û–°–¢–ê–í–ï!`, selectedType);
    });

    tabAll.addEventListener('click', () => {
        currentTab = 'all';
        tabAll.classList.add('active');
        tabSelected.classList.remove('active');
        tabReceipt.classList.remove('active');
        renderTabContent();
    });

    tabSelected.addEventListener('click', () => {
        currentTab = 'selected';
        tabSelected.classList.add('active');
        tabAll.classList.remove('active');
        tabReceipt.classList.remove('active');
        renderTabContent();
    });

    tabReceipt.addEventListener('click', () => {
        currentTab = 'receipt';
        tabReceipt.classList.add('active');
        tabAll.classList.remove('active');
        tabSelected.classList.remove('active');
        renderTabContent();
    });

    function renderTabContent() {
        if (participants.length === 0) {
            inputContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –≥–æ–Ω—â–∏–∫–æ–≤</div>';
            return;
        }

        if (currentTab === 'all') {
            inputContainer.innerHTML = `
                <div style="margin: 15px 0;">
                    <input type="number" id="allAmount" placeholder="–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö" min="0" step="1" style="font-size: 20px; padding: 18px;">
                </div>
            `;
        } 
        else if (currentTab === 'selected') {
            let checkboxes = '';
            participants.forEach(p => {
                checkboxes += `
                    <label class="participant-check-item">
                        <input type="checkbox" class="selected-checkbox" value="${p.name}" checked> ${p.type} ${p.name}
                    </label>
                `;
            });
            
            inputContainer.innerHTML = `
                <div style="font-weight: bold; margin: 10px 0;">üë• –ö—Ç–æ —É—á–∞—Å—Ç–≤—É–µ—Ç:</div>
                <div class="participants-checkbox">${checkboxes}</div>
                <input type="number" id="selectedAmount" placeholder="–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö" min="0" step="1" style="font-size: 20px; padding: 18px;">
            `;
        } 
        else if (currentTab === 'receipt') {
            inputContainer.innerHTML = `
                <div id="receiptItems"></div>
                <button class="add-item-btn" id="addReceiptItemBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
            `;
            
            const receiptItems = document.getElementById('receiptItems');
            if (receiptItems.children.length === 0) {
                addReceiptItem();
            }
            
            document.getElementById('addReceiptItemBtn').addEventListener('click', addReceiptItem);
        }
    }

    function addReceiptItem() {
        const receiptItems = document.getElementById('receiptItems');
        const id = Date.now() + Math.random();
        
        let checkboxes = '';
        participants.forEach(p => {
            checkboxes += `
                <label class="participant-check-item">
                    <input type="checkbox" class="receipt-consumer" value="${p.name}" checked> ${p.type} ${p.name}
                </label>
            `;
        });
        
        const html = `
            <div class="receipt-item" data-id="${id}">
                <div class="receipt-header">
                    <h4>üçΩÔ∏è –ü–æ–∑–∏—Ü–∏—è</h4>
                    <button class="remove-item" onclick="this.closest('.receipt-item').remove()">‚úï –£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <select class="receipt-category" style="margin-bottom: 10px;">
                    ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                </select>
                <input type="number" class="receipt-amount" placeholder="–°—É–º–º–∞" min="0" step="1" style="margin-bottom: 10px;">
                <div style="font-weight: bold; margin: 5px 0;">üë• –ö—Ç–æ —ç—Ç–æ –ø–æ—Ç—Ä–µ–±–ª—è–ª:</div>
                <div class="participants-checkbox">${checkboxes}</div>
            </div>
        `;
        
        receiptItems.insertAdjacentHTML('beforeend', html);
    }

    addExpenseBtn.addEventListener('click', function() {
        const payer = payerSelect.value;
        if (!payer) {
            showJoke('–í–´–ë–ï–†–ò, –ö–¢–û –ü–õ–ê–¢–ò–¢!', 'üë§');
            return;
        }

        if (currentTab === 'all') {
            const amount = parseFloat(document.getElementById('allAmount')?.value);
            if (!amount || amount <= 0) {
                showJoke('–í–í–ï–î–ò –°–£–ú–ú–£!', 'üí∞');
                return;
            }
            
            saveExpense(payer, [{
                category: selectedCategory,
                amount: amount,
                consumers: participants.map(p => p.name)
            }], amount, 'all');
        }
        else if (currentTab === 'selected') {
            const amount = parseFloat(document.getElementById('selectedAmount')?.value);
            if (!amount || amount <= 0) {
                showJoke('–í–í–ï–î–ò –°–£–ú–ú–£!', 'üí∞');
                return;
            }
            
            const consumers = [];
            document.querySelectorAll('.selected-checkbox:checked').forEach(cb => {
                consumers.push(cb.value);
            });
            
            if (consumers.length === 0) {
                showJoke('–í–´–ë–ï–†–ò, –ö–¢–û –£–ß–ê–°–¢–í–£–ï–¢!', 'üë•');
                return;
            }
            
            saveExpense(payer, [{
                category: selectedCategory,
                amount: amount,
                consumers: consumers
            }], amount, 'selected');
        }
        else if (currentTab === 'receipt') {
            const items = document.querySelectorAll('.receipt-item');
            if (items.length === 0) {
                showJoke('–î–û–ë–ê–í–¨ –•–û–¢–¨ –û–î–ù–£ –ü–û–ó–ò–¶–ò–Æ!', 'üçΩÔ∏è');
                return;
            }
            
            let total = 0;
            const receiptItems = [];
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const category = item.querySelector('.receipt-category').value;
                const amount = parseFloat(item.querySelector('.receipt-amount').value);
                
                if (!amount || amount <= 0) {
                    showJoke(`–í –ü–û–ó–ò–¶–ò–ò ${i+1} –°–£–ú–ú–ê –ö–†–ò–í–ê–Ø!`, 'üí∞');
                    return;
                }
                
                const consumers = [];
                item.querySelectorAll('.receipt-consumer:checked').forEach(cb => {
                    consumers.push(cb.value);
                });
                
                if (consumers.length === 0) {
                    showJoke(`–í –ü–û–ó–ò–¶–ò–ò ${i+1} –í–´–ë–ï–†–ò –ü–û–¢–†–ï–ë–ò–¢–ï–õ–ï–ô!`, 'üë•');
                    return;
                }
                
                receiptItems.push({ category, amount, consumers });
                total += amount;
            }
            
            saveExpense(payer, receiptItems, total, 'receipt');
        }
    });

    function saveExpense(payer, items, total, type) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'numeric' });
        const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

        expenses.push({
            payer,
            items,
            total,
            type,
            date: dateStr,
            time: timeStr,
            timestamp: now.getTime()
        });

        if (currentTab === 'all') {
            document.getElementById('allAmount').value = '';
        } else if (currentTab === 'selected') {
            document.getElementById('selectedAmount').value = '';
        } else if (currentTab === 'receipt') {
            document.getElementById('receiptItems').innerHTML = '';
            addReceiptItem();
        }

        renderFullList();
        renderDebts();
        saveToFirebase();
        showJoke();
    }

    function deleteExpense(index) {
        pendingDeleteIndex = index;
        const deleteJokes = [
            '–£–í–ï–†–ï–ù –ß–¢–û –•–û–ß–ï–®–¨ –£–î–ê–õ–ò–¢–¨? –ê –ï–°–õ–ò –ü–û–î–£–ú–ê–¢–¨?',
            '–£–î–ê–õ–ò–®–¨ ‚Äî –ë–û–õ–¨–®–ï –ù–ï –í–ï–†–ù–Å–®–¨, –õ–û–•!',
            '–¢–û–ß–ù–û? –ú–û–ñ–ï–¢ –õ–£–ß–®–ï –û–°–¢–ê–í–ò–ú?',
            '–≠–¢–£ –¢–†–ê–¢–£ –ñ–ê–õ–ö–û, –ù–û –î–ï–õ–û –¢–í–û–Å',
            '–ü–û–î–¢–í–ï–†–î–ò –£–î–ê–õ–ï–ù–ò–ï, –ï–°–õ–ò –ù–ï –¢–†–£–°'
        ];
        showJoke(deleteJokes[Math.floor(Math.random() * deleteJokes.length)], 'üóëÔ∏è');
    }

    function renderFullList() {
        if (expenses.length === 0) {
            fullListDiv.innerHTML = '<div class="empty-state">‚õ∑Ô∏è –ü–û–ö–ê –ù–ò–ß–ï–ì–û –ù–ï–¢</div>';
            return;
        }
        
        let html = '';
        [...expenses].reverse().forEach((exp, revIndex) => {
            const originalIndex = expenses.length - 1 - revIndex;
            
            let typeEmoji = 'üçª';
            if (exp.type === 'selected') typeEmoji = 'üéØ';
            if (exp.type === 'receipt') typeEmoji = 'üìù';
            
            const payerData = participants.find(p => p.name === exp.payer);
            const payerType = payerData ? payerData.type : 'üë§';
            
            html += `
                <div class="expense-item">
                    <div class="expense-left">
                        <span class="expense-badge">${typeEmoji}</span>
                        <span class="expense-payer">${payerType} ${exp.payer}</span>
                        <span>${exp.items.length} –ø–æ–∑.</span>
                        <span>${exp.date}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span style="font-weight: 800; margin-right: 10px;">${exp.total} ‚ÇΩ</span>
                        <button class="delete-btn" onclick="deleteExpense(${originalIndex})">‚úï</button>
                    </div>
                </div>
            `;
        });
        
        fullListDiv.innerHTML = html;
    }

    function renderDebts() {
        if (expenses.length === 0 || participants.length === 0) {
            debtsDiv.innerHTML = '<div class="empty-state">‚õ∑Ô∏è –î–û–ë–ê–í–¨ –¢–†–ê–¢–´</div>';
            totalSpan.innerHTML = '0 ‚ÇΩ';
            return;
        }

        let balance = {};
        participants.forEach(p => balance[p.name] = 0);

        expenses.forEach(exp => {
            const payer = exp.payer;
            balance[payer] += exp.total;
            
            exp.items.forEach(item => {
                const share = item.amount / item.consumers.length;
                item.consumers.forEach(consumer => {
                    balance[consumer] -= share;
                });
            });
        });

        participants.forEach(p => {
            balance[p.name] = Math.round(balance[p.name] * 100) / 100;
        });

        let debtors = [];
        let creditors = [];

        participants.forEach(p => {
            const bal = balance[p.name];
            if (bal < -0.01) debtors.push({ name: p.name, amount: -bal });
            else if (bal > 0.01) creditors.push({ name: p.name, amount: bal });
        });

        let transactions = [];
        let i = 0, j = 0;
        let sortedDebtors = debtors.map(d => ({ ...d }));
        let sortedCreditors = creditors.map(c => ({ ...c }));

        while (i < sortedDebtors.length && j < sortedCreditors.length) {
            let debtor = sortedDebtors[i];
            let creditor = sortedCreditors[j];
            let amount = Math.min(debtor.amount, creditor.amount);
            amount = Math.round(amount * 100) / 100;

            if (amount > 0.01) {
                transactions.push({ from: debtor.name, to: creditor.name, amount });
            }

            debtor.amount -= amount;
            creditor.amount -= amount;

            if (debtor.amount < 0.01) i++;
            if (creditor.amount < 0.01) j++;
        }

        if (transactions.length === 0) {
            debtsDiv.innerHTML = '<div class="empty-state">üí∞ –í–°–ï –ü–†–ò –°–í–û–ò–•</div>';
        } else {
            let html = '';
            transactions.forEach(t => {
                html += `
                    <div class="debt-item">
                        <div><span class="debt-payer">${t.from}</span> ‚Üí <span class="debt-receiver">${t.to}</span></div>
                        <div class="debt-amount">üí∏ ${t.amount} ‚ÇΩ</div>
                    </div>
                `;
            });
            debtsDiv.innerHTML = html;
        }

        const total = expenses.reduce((sum, exp) => sum + exp.total, 0);
        totalSpan.innerHTML = `üí∞ –í–°–ï–ì–û: ${total} ‚ÇΩ`;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.deleteExpense = deleteExpense;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadFromFirebase();
</script>
</body>
</html>
