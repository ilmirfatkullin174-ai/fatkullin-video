<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatkullin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #0a1a2a;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .app {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 30px;
            overflow: hidden;
        }
        
        .header {
            background: #1e2f4a;
            color: white;
            padding: 30px 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .content {
            padding: 20px;
        }
        
        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 15px;
            margin: 5px 0;
            border: none;
            border-radius: 25px;
            background: #fbbf24;
            color: #1e2f4a;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .hidden {
            display: none;
        }
        
        .contact {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online {
            color: green;
            font-size: 14px;
        }
        
        .offline {
            color: gray;
            font-size: 14px;
        }
        
        video {
            width: 100%;
            background: black;
            border-radius: 15px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">Fatkullin</div>
        <div class="content">
            <!-- –≠–∫—Ä–∞–Ω 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–≤—Ö–æ–¥ -->
            <div id="screen1">
                <input type="text" id="name" placeholder="–ò–º—è">
                <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
                <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button onclick="login()">–í–æ–π—Ç–∏</button>
                <div id="message" style="color: red; text-align: center;"></div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 2: –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
            <div id="screen2" class="hidden">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <h3 id="myName"></h3>
                        <p id="myPhone"></p>
                    </div>
                    <button onclick="logout()" style="width: auto; padding: 10px;">–í—ã–π—Ç–∏</button>
                </div>
                
                <input type="tel" id="addPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è">
                <button onclick="addContact()">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
                
                <div id="contactsList"></div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 3: –ó–≤–æ–Ω–æ–∫ -->
            <div id="screen3" class="hidden">
                <video id="remoteVideo" autoplay></video>
                <video id="localVideo" autoplay muted></video>
                <button onclick="endCall()" style="background: red; color: white;">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        let contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
        let onlineUsers = new Set();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if (currentUser) {
            showScreen2();
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        function register() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            
            if (!name || !phone || !password) {
                document.getElementById('message').innerText = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                return;
            }
            
            if (users.find(u => u.phone === phone)) {
                document.getElementById('message').innerText = '–¢–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –µ—Å—Ç—å';
                return;
            }
            
            const newUser = {
                id: Date.now() + '',
                name: name,
                phone: phone,
                password: password
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            currentUser = newUser;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            showScreen2();
        }
        
        // –í—Ö–æ–¥
        function login() {
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.phone === phone && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showScreen2();
            } else {
                document.getElementById('message').innerText = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
            }
        }
        
        // –í—ã—Ö–æ–¥
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showScreen1();
        }
        
        // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
        function addContact() {
            const phone = document.getElementById('addPhone').value;
            const user = users.find(u => u.phone === phone && u.id !== currentUser.id);
            
            if (user) {
                if (!contacts.find(c => c.id === user.id)) {
                    contacts.push({
                        id: user.id,
                        name: user.name,
                        phone: user.phone
                    });
                    localStorage.setItem('contacts', JSON.stringify(contacts));
                    renderContacts();
                    document.getElementById('addPhone').value = '';
                } else {
                    alert('–ö–æ–Ω—Ç–∞–∫—Ç —É–∂–µ –µ—Å—Ç—å');
                }
            } else {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã
        function renderContacts() {
            const list = document.getElementById('contactsList');
            
            if (contacts.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: gray;">–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>';
                return;
            }
            
            list.innerHTML = '';
            contacts.forEach(contact => {
                const div = document.createElement('div');
                div.className = 'contact';
                div.innerHTML = `
                    <div>
                        <strong>${contact.name}</strong>
                        <div class="${onlineUsers.has(contact.id) ? 'online' : 'offline'}">
                            ${onlineUsers.has(contact.id) ? '‚óè –≤ —Å–µ—Ç–∏' : '‚óã –Ω–µ –≤ —Å–µ—Ç–∏'}
                        </div>
                    </div>
                    <button onclick="call('${contact.id}', '${contact.name}')">üìπ</button>
                `;
                list.appendChild(div);
            });
        }
        
        // –ó–≤–æ–Ω–æ–∫
        async function call(id, name) {
            if (!onlineUsers.has(id)) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–µ—Ç–∏');
                return;
            }
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                showScreen3();
                
                // –î–ª—è —Ç–µ—Å—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—ë –≤–∏–¥–µ–æ –∏ –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω–æ–µ
                setTimeout(() => {
                    document.getElementById('remoteVideo').srcObject = localStream;
                }, 1000);
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã');
            }
        }
        
        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
            }
            showScreen2();
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        function showScreen1() {
            document.getElementById('screen1').classList.remove('hidden');
            document.getElementById('screen2').classList.add('hidden');
            document.getElementById('screen3').classList.add('hidden');
        }
        
        function showScreen2() {
            document.getElementById('screen1').classList.add('hidden');
            document.getElementById('screen2').classList.remove('hidden');
            document.getElementById('screen3').classList.add('hidden');
            
            document.getElementById('myName').innerText = currentUser.name;
            document.getElementById('myPhone').innerText = currentUser.phone;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ –æ–Ω–ª–∞–π–Ω
            onlineUsers.add(currentUser.id);
            
            renderContacts();
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –æ–Ω–ª–∞–π–Ω–∞ –¥—Ä—É–≥–∏—Ö
            setInterval(() => {
                contacts.forEach(contact => {
                    if (Math.random() > 0.5) {
                        onlineUsers.add(contact.id);
                    } else {
                        onlineUsers.delete(contact.id);
                    }
                });
                renderContacts();
            }, 5000);
        }
        
        function showScreen3() {
            document.getElementById('screen1').classList.add('hidden');
            document.getElementById('screen2').classList.add('hidden');
            document.getElementById('screen3').classList.remove('hidden');
        }
    </script>
</body>
</html>
