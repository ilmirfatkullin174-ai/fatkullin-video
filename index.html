<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatkullin Video</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a2f4a;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .app {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 40px;
            overflow: hidden;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }
        
        .header {
            background: #1a2f4a;
            padding: 30px 20px;
            color: white;
            text-align: center;
        }
        
        .logo {
            font-size: 32px;
            font-weight: 800;
            color: #fbbf24;
            margin-bottom: 15px;
        }
        
        .content {
            padding: 24px 20px;
            background: #f8fafc;
        }
        
        .card {
            background: white;
            border-radius: 24px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .id-box {
            background: #1e293b;
            color: #fbbf24;
            padding: 20px;
            border-radius: 20px;
            font-size: 24px;
            text-align: center;
            letter-spacing: 3px;
            margin: 15px 0;
            word-break: break-all;
        }
        
        input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            font-size: 16px;
            margin: 8px 0;
        }
        
        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 700;
            background: #fbbf24;
            color: #1a2f4a;
            margin: 8px 0;
            cursor: pointer;
            box-shadow: 0 5px 0 #b45309;
        }
        
        button:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #b45309;
        }
        
        button.danger {
            background: #dc2626;
            color: white;
            box-shadow: 0 5px 0 #7f1d1d;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            min-height: 400px;
            background: #0f172a;
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #localVideo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 140px;
            border-radius: 12px;
            border: 3px solid white;
            object-fit: cover;
        }
        
        .hidden {
            display: none;
        }
        
        .status {
            text-align: center;
            color: #64748b;
            margin: 10px 0;
        }
        
        .grid {
            display: flex;
            gap: 10px;
        }
        
        .grid button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="logo">Fatkullin Video</div>
            <div>–°–µ–º–µ–π–Ω—ã–µ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏</div>
        </div>
        
        <div class="content">
            <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
            <div id="loginScreen">
                <div class="card">
                    <h3 style="margin-bottom: 15px;">üëã –í—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
                    <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è" value="–£—á–∞—Å—Ç–Ω–∏–∫">
                    <button id="joinBtn">–í–æ–π—Ç–∏</button>
                </div>
            </div>
            
            <!-- –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù -->
            <div id="mainScreen" class="hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 id="displayName"></h3>
                        <button class="danger" id="logoutBtn" style="width: auto; padding: 10px 20px;">–í—ã–π—Ç–∏</button>
                    </div>
                    <div class="id-box" id="myId"></div>
                    <p class="status">‚¨ÜÔ∏è –≠—Ç–æ –≤–∞—à ID. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∏–º —Å —Ç–µ–º–∏, –∫—Ç–æ —Ö–æ—á–µ—Ç –≤–∞–º –ø–æ–∑–≤–æ–Ω–∏—Ç—å</p>
                </div>
                
                <div class="card">
                    <h3>üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</h3>
                    <input type="text" id="targetId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
                    <button id="callBtn">–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
                </div>
                
                <div class="card" id="activeCall" style="display: none;">
                    <div class="video-container">
                        <video id="remoteVideo" autoplay playsinline></video>
                        <video id="localVideo" autoplay playsinline muted></video>
                    </div>
                    <div class="grid">
                        <button id="muteAudioBtn">üîá –í—ã–∫–ª –∑–≤—É–∫</button>
                        <button id="muteVideoBtn">üìπ –í—ã–∫–ª –≤–∏–¥–µ–æ</button>
                    </div>
                    <button class="danger" id="hangupBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
                </div>
            </div>
            
            <!-- –≠–ö–†–ê–ù –í–•–û–î–Ø–©–ï–ì–û –ó–í–û–ù–ö–ê -->
            <div id="incomingScreen" class="hidden">
                <div class="card">
                    <h3>üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫!</h3>
                    <p id="callerInfo">–í–∞–º –∑–≤–æ–Ω—è—Ç</p>
                    <div class="grid">
                        <button id="answerBtn">‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                        <button class="danger" id="rejectBtn">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ü–†–û–°–¢–ê–Ø –°–ò–ì–ù–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        
        class SimpleSignaling {
            constructor() {
                this.users = JSON.parse(localStorage.getItem('users') || '{}');
                this.currentUser = null;
                this.localStream = null;
                this.peerConnection = null;
                this.pendingCalls = [];
                
                // STUN —Å–µ—Ä–≤–µ—Ä—ã Google (—Ä–∞–±–æ—Ç–∞—é—Ç –≤—Å–µ–≥–¥–∞)
                this.config = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                };
                
                this.init();
            }
            
            init() {
                // –í—Ö–æ–¥
                document.getElementById('joinBtn').onclick = () => {
                    const name = document.getElementById('userName').value || '–£—á–∞—Å—Ç–Ω–∏–∫';
                    this.login(name);
                };
                
                // –í—ã—Ö–æ–¥
                document.getElementById('logoutBtn').onclick = () => {
                    this.logout();
                };
                
                // –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
                document.getElementById('callBtn').onclick = () => {
                    const targetId = document.getElementById('targetId').value;
                    if (targetId) this.startCall(targetId);
                };
                
                // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
                document.getElementById('hangupBtn').onclick = () => {
                    this.endCall();
                };
                
                // –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫
                document.getElementById('answerBtn').onclick = () => {
                    this.answerCall();
                };
                
                // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–≤–æ–Ω–æ–∫
                document.getElementById('rejectBtn').onclick = () => {
                    this.rejectCall();
                };
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–º/–≤–∏–¥–µ–æ
                document.getElementById('muteAudioBtn').onclick = (e) => {
                    if (this.localStream) {
                        const enabled = this.localStream.getAudioTracks()[0].enabled;
                        this.localStream.getAudioTracks()[0].enabled = !enabled;
                        e.target.textContent = !enabled ? 'üîä –í–∫–ª –∑–≤—É–∫' : 'üîá –í—ã–∫–ª –∑–≤—É–∫';
                    }
                };
                
                document.getElementById('muteVideoBtn').onclick = (e) => {
                    if (this.localStream) {
                        const enabled = this.localStream.getVideoTracks()[0].enabled;
                        this.localStream.getVideoTracks()[0].enabled = !enabled;
                        e.target.textContent = !enabled ? 'üìπ –í–∫–ª –≤–∏–¥–µ–æ' : 'üìπ –í—ã–∫–ª –≤–∏–¥–µ–æ';
                    }
                };
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥—è—â–∏–µ –≤—ã–∑–æ–≤—ã –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                setInterval(() => this.checkIncomingCalls(), 1000);
            }
            
            login(name) {
                // –°–æ–∑–¥–∞—ë–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                const id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                
                this.currentUser = {
                    id: id,
                    name: name,
                    online: true
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                this.users[id] = this.currentUser;
                localStorage.setItem('users', JSON.stringify(this.users));
                localStorage.setItem('currentUser', id);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                document.getElementById('displayName').textContent = `üë§ ${name}`;
                document.getElementById('myId').textContent = id;
            }
            
            logout() {
                if (this.currentUser) {
                    delete this.users[this.currentUser.id];
                    localStorage.setItem('users', JSON.stringify(this.users));
                    localStorage.removeItem('currentUser');
                }
                
                if (this.localStream) {
                    this.localStream.getTracks().forEach(t => t.stop());
                }
                
                if (this.peerConnection) {
                    this.peerConnection.close();
                }
                
                document.getElementById('mainScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('activeCall').style.display = 'none';
            }
            
            async startCall(targetId) {
                const target = this.users[targetId];
                if (!target) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –≤ —Å–µ—Ç–∏');
                    return;
                }
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    
                    document.getElementById('localVideo').srcObject = this.localStream;
                    
                    // –°–æ–∑–¥–∞—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    this.peerConnection = new RTCPeerConnection(this.config);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });
                    
                    // –ü–æ–ª—É—á–∞–µ–º —É–¥–∞–ª—ë–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
                    this.peerConnection.ontrack = (event) => {
                        document.getElementById('remoteVideo').srcObject = event.streams[0];
                    };
                    
                    // –û–±–º–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                            this.saveCandidate(targetId, event.candidate);
                        }
                    };
                    
                    // –°–æ–∑–¥–∞—ë–º –æ—Ñ—Ñ–µ—Ä
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
                    this.saveOffer(targetId, {
                        from: this.currentUser.id,
                        fromName: this.currentUser.name,
                        offer: offer
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–≤–æ–Ω–∫–∞
                    document.getElementById('activeCall').style.display = 'block';
                    
                    alert('‚úÖ –ó–≤–æ–Ω–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ñ–¥—ë–º –æ—Ç–≤–µ—Ç–∞...');
                    
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                }
            }
            
            async answerCall() {
                const call = this.pendingCalls[0];
                if (!call) return;
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    
                    document.getElementById('localVideo').srcObject = this.localStream;
                    
                    // –°–æ–∑–¥–∞—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    this.peerConnection = new RTCPeerConnection(this.config);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });
                    
                    // –ü–æ–ª—É—á–∞–µ–º —É–¥–∞–ª—ë–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
                    this.peerConnection.ontrack = (event) => {
                        document.getElementById('remoteVideo').srcObject = event.streams[0];
                    };
                    
                    // –û–±–º–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            this.saveCandidate(call.from, event.candidate);
                        }
                    };
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª—ë–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ—Ñ—Ñ–µ—Ä)
                    await this.peerConnection.setRemoteDescription(call.offer);
                    
                    // –°–æ–∑–¥–∞—ë–º –æ—Ç–≤–µ—Ç
                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                    this.saveAnswer(call.from, answer);
                    
                    // –ü—Ä—è—á–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥—è—â–µ–≥–æ
                    document.getElementById('incomingScreen').classList.add('hidden');
                    document.getElementById('mainScreen').classList.remove('hidden');
                    document.getElementById('activeCall').style.display = 'block';
                    
                    this.pendingCalls = [];
                    
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ');
                }
            }
            
            rejectCall() {
                this.pendingCalls = [];
                document.getElementById('incomingScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
            }
            
            endCall() {
                if (this.localStream) {
                    this.localStream.getTracks().forEach(t => t.stop());
                }
                
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }
                
                document.getElementById('activeCall').style.display = 'none';
                document.getElementById('remoteVideo').srcObject = null;
            }
            
            // ============ –•–†–ê–ù–ò–õ–ò–©–ï –°–ò–ì–ù–ê–õ–û–í ============
            
            saveOffer(to, offer) {
                const offers = JSON.parse(localStorage.getItem('offers') || '{}');
                if (!offers[to]) offers[to] = [];
                offers[to].push(offer);
                localStorage.setItem('offers', JSON.stringify(offers));
            }
            
            saveAnswer(to, answer) {
                const answers = JSON.parse(localStorage.getItem('answers') || '{}');
                if (!answers[to]) answers[to] = [];
                answers[to].push(answer);
                localStorage.setItem('answers', JSON.stringify(answers));
            }
            
            saveCandidate(to, candidate) {
                const candidates = JSON.parse(localStorage.getItem('candidates') || '{}');
                if (!candidates[to]) candidates[to] = [];
                candidates[to].push(candidate);
                localStorage.setItem('candidates', JSON.stringify(candidates));
            }
            
            checkIncomingCalls() {
                if (!this.currentUser) return;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥—è—â–∏–µ –æ—Ñ—Ñ–µ—Ä—ã
                const offers = JSON.parse(localStorage.getItem('offers') || '{}');
                const myOffers = offers[this.currentUser.id] || [];
                
                if (myOffers.length > 0 && this.pendingCalls.length === 0) {
                    this.pendingCalls = myOffers;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
                    document.getElementById('mainScreen').classList.add('hidden');
                    document.getElementById('incomingScreen').classList.remove('hidden');
                    document.getElementById('callerInfo').textContent = 
                        `üìû –ó–≤–æ–Ω–∏—Ç: ${myOffers[0].fromName || myOffers[0].from}`;
                    
                    // –û—á–∏—â–∞–µ–º –æ—Ñ—Ñ–µ—Ä—ã
                    delete offers[this.currentUser.id];
                    localStorage.setItem('offers', JSON.stringify(offers));
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç—ã (–µ—Å–ª–∏ –º—ã –∑–≤–æ–Ω–∏–ª–∏)
                const answers = JSON.parse(localStorage.getItem('answers') || '{}');
                const myAnswers = answers[this.currentUser.id] || [];
                
                if (myAnswers.length > 0 && this.peerConnection) {
                    this.peerConnection.setRemoteDescription(myAnswers[0]);
                    delete answers[this.currentUser.id];
                    localStorage.setItem('answers', JSON.stringify(answers));
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                const candidates = JSON.parse(localStorage.getItem('candidates') || '{}');
                const myCandidates = candidates[this.currentUser.id] || [];
                
                if (myCandidates.length > 0 && this.peerConnection) {
                    myCandidates.forEach(candidate => {
                        this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    });
                    delete candidates[this.currentUser.id];
                    localStorage.setItem('candidates', JSON.stringify(candidates));
                }
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        new SimpleSignaling();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è
        window.onload = () => {
            const savedId = localStorage.getItem('currentUser');
            if (savedId) {
                document.getElementById('userName').value = '–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!';
            }
        };
    </script>
</body>
</html>
